services:
  gateway:
    image: nginx:1.25-alpine
    container_name: libapartado-gateway
    restart: unless-stopped
    depends_on:
      - accounts
      - spaces
      - reservations
    ports:
      - "8080:80"
    volumes:
      - ./gateway/nginx.conf:/etc/nginx/conf.d/default.conf:ro

  frontend:
    build:
      context: frontend
      dockerfile: Dockerfile
    container_name: libapartado-frontend
    restart: unless-stopped
    depends_on:
      - gateway
    ports:
      - "3000:80"
    volumes:
      # Permite servir la versiÃ³n build local sin reconstruir la imagen
      - ./frontend/dist:/usr/share/nginx/html:ro

  accounts-db:
    image: mysql:8.0
    container_name: accounts-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${ACCOUNTS_DB_NAME:-accounts_db}
      MYSQL_USER: ${ACCOUNTS_DB_USER:-accounts_user}
      MYSQL_PASSWORD: ${ACCOUNTS_DB_PASSWORD:-accounts_pass}
      MYSQL_ROOT_PASSWORD: ${ACCOUNTS_DB_ROOT_PASSWORD:-rootpass}
    ports:
      - "3307:3306"
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    volumes:
      - accounts_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u$$MYSQL_USER -p$$MYSQL_PASSWORD"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  accounts:
    build:
      context: .
      dockerfile: services/accounts_service/Dockerfile
    container_name: accounts-service
    restart: unless-stopped
    depends_on:
      accounts-db:
        condition: service_healthy
    environment:
      DJANGO_DEBUG: ${ACCOUNTS_DEBUG:-0}
      DJANGO_SECRET_KEY: ${ACCOUNTS_SECRET_KEY:-change-me}
      ALLOWED_HOSTS: ${ACCOUNTS_ALLOWED_HOSTS:-localhost,127.0.0.1,0.0.0.0,192.168.43.30,gateway,accounts,frontend}
      DB_HOST: accounts-db
      DB_PORT: 3306
      DB_NAME: ${ACCOUNTS_DB_NAME:-accounts_db}
      DB_USER: ${ACCOUNTS_DB_USER:-accounts_user}
      DB_PASSWORD: ${ACCOUNTS_DB_PASSWORD:-accounts_pass}
      TIME_ZONE: America/Bogota
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://localhost:8080,http://localhost:3000
      JWT_SECRET: ${JWT_SECRET:-super-secret-jwt}
      ADMIN_EMAIL: ${ADMIN_EMAIL:-adminlocal@fesc.edu.co}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:-FESC2025}
      ADMIN_FIRST_NAME: ${ADMIN_FIRST_NAME:-Admin}
      ADMIN_LAST_NAME: ${ADMIN_LAST_NAME:-Local}
    command: >
      sh -c "python wait_for_db.py && python manage.py migrate && python create_admin.py && gunicorn accounts_service.wsgi:application --bind 0.0.0.0:8000 --workers 2 --threads 2 --timeout 120"

  spaces-db:
    image: mysql:8.0
    container_name: spaces-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${SPACES_DB_NAME:-spaces_db}
      MYSQL_USER: ${SPACES_DB_USER:-spaces_user}
      MYSQL_PASSWORD: ${SPACES_DB_PASSWORD:-spaces_pass}
      MYSQL_ROOT_PASSWORD: ${SPACES_DB_ROOT_PASSWORD:-rootpass}
    ports:
      - "3308:3306"
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    volumes:
      - spaces_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u$$MYSQL_USER -p$$MYSQL_PASSWORD"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  spaces:
    build:
      context: .
      dockerfile: services/spaces_service/Dockerfile
    container_name: spaces-service
    restart: unless-stopped
    depends_on:
      spaces-db:
        condition: service_healthy
      reservations:
        condition: service_started
    environment:
      DJANGO_DEBUG: ${SPACES_DEBUG:-0}
      DJANGO_SECRET_KEY: ${SPACES_SECRET_KEY:-change-me}
      ALLOWED_HOSTS: ${SPACES_ALLOWED_HOSTS:-localhost,127.0.0.1,0.0.0.0,192.168.43.30,gateway,spaces,frontend}
      DB_HOST: spaces-db
      DB_PORT: 3306
      DB_NAME: ${SPACES_DB_NAME:-spaces_db}
      DB_USER: ${SPACES_DB_USER:-spaces_user}
      DB_PASSWORD: ${SPACES_DB_PASSWORD:-spaces_pass}
      TIME_ZONE: America/Bogota
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://localhost:8080,http://localhost:3000
      JWT_SECRET: ${JWT_SECRET:-super-secret-jwt}
      RESERVATIONS_BASE_URL: http://reservations:8000/api
    command: >
      sh -c "python wait_for_db.py && python manage.py migrate && gunicorn spaces_service.wsgi:application --bind 0.0.0.0:8000 --workers 2 --threads 2 --timeout 120"

  reservations-db:
    image: mysql:8.0
    container_name: reservations-db
    restart: unless-stopped
    environment:
      MYSQL_DATABASE: ${RESERVATIONS_DB_NAME:-reservations_db}
      MYSQL_USER: ${RESERVATIONS_DB_USER:-reservations_user}
      MYSQL_PASSWORD: ${RESERVATIONS_DB_PASSWORD:-reservations_pass}
      MYSQL_ROOT_PASSWORD: ${RESERVATIONS_DB_ROOT_PASSWORD:-rootpass}
    ports:
      - "3309:3306"
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci
    volumes:
      - reservations_mysql_data:/var/lib/mysql
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -u$$MYSQL_USER -p$$MYSQL_PASSWORD"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 15s

  reservations:
    build:
      context: .
      dockerfile: services/reservations_service/Dockerfile
    container_name: reservations-service
    restart: unless-stopped
    depends_on:
      reservations-db:
        condition: service_healthy
    environment:
      DJANGO_DEBUG: ${RESERVATIONS_DEBUG:-0}
      DJANGO_SECRET_KEY: ${RESERVATIONS_SECRET_KEY:-change-me}
      ALLOWED_HOSTS: ${RESERVATIONS_ALLOWED_HOSTS:-localhost,127.0.0.1,0.0.0.0,192.168.43.30,gateway,reservations,frontend}
      DB_HOST: reservations-db
      DB_PORT: 3306
      DB_NAME: ${RESERVATIONS_DB_NAME:-reservations_db}
      DB_USER: ${RESERVATIONS_DB_USER:-reservations_user}
      DB_PASSWORD: ${RESERVATIONS_DB_PASSWORD:-reservations_pass}
      TIME_ZONE: America/Bogota
      CORS_ALLOWED_ORIGINS: http://localhost:3000,http://localhost:8080,http://localhost:3000
      JWT_SECRET: ${JWT_SECRET:-super-secret-jwt}
      RESERVATION_MIN_DURATION_MINUTES: 30
      RESERVATION_MAX_DURATION_HOURS: 4
      SPACES_BASE_URL: http://spaces:8000/api
    command: >
      sh -c "python wait_for_db.py && python manage.py migrate && gunicorn reservations_service.wsgi:application --bind 0.0.0.0:8000 --workers 2 --threads 2 --timeout 120"

volumes:
  accounts_mysql_data:
  spaces_mysql_data:
  reservations_mysql_data:
